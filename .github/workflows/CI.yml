name: CI
on:
  push:
    branches:
      - master
  pull_request:

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      workflows: steps.check-workflows.outputs.any_changed
      frontend: steps.check-frontend.outputs.any_changed
      markdown: steps.check-markdown.outputs.any_changed
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Check workflow files
        id: check-workflows
        uses: tj-actions/changed-files@v20
        with:
          files: |
            .github/workflows/*.yml
      - name: Check frontend files
        id: check-frontend
        uses: tj-actions/changed-files@v20
        with:
          files: |
            web/**/*
          files_ignore:
            web/public/locales/*.json
            web/**/*.md
      - name: Check markdown files
        id: check-markdown
        uses: tj-actions/changed-files@v20
        with:
          files: |
            *.md

  validate_local_links:
    name: Validate local links in markdown files
    needs: [setup]
    runs-on: ubuntu-latest
    if: (needs.setup.outputs.markdown == 'true' || needs.setup.outputs.workflows == 'true')
    steps:
      - uses: ./.github/workflows/validate-local-links-in-md

  cypress:
    name: Cypress tests
    needs: [setup]
    runs-on: ubuntu-latest
    if: (needs.setup.outputs.frontend == 'true') || needs.setup.outputs.workflows == 'true')
    steps:
      - uses: ./.github/workflows/cypress